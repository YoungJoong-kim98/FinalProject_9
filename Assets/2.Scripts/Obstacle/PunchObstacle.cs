using System.Collections;
using UnityEngine;

public class PunchObstacle : MonoBehaviour
{
    //미는 힘
    [SerializeField] private float _pushPower = -1f;
    //펀치하는 속도
    [SerializeField] private float _pushSpeed = -1f;
    //돌아가는 속도
    [SerializeField] private float _backSpeed = -1f;
    //움직이는 거리
    [SerializeField] private float _moveDistance = -1f;
    //움직이는 방향
    [SerializeField] private Vector3 _direction = Vector3.forward;
     
    //정기적으로 실행되는지 여부
    [SerializeField] private bool _isReglar = false;
    //실행 빈도
    [SerializeField] private float _regularTime = 1f;

    //원래 위치
    private Vector3 _startPos;
    //목표 위치
    private Vector3 _targetPos;
    //플레그
    private bool _isPunching = false;
    //코루틴
    private Coroutine _punchCoroutine;    

    private void Start()
    {
        //데이터 초기화
        var data = ObstacleManager.Instance.obstacleData;
        Utilitys.SetIfNegative(ref _pushPower, data.pushPower);
        Utilitys.SetIfNegative(ref _pushSpeed, data.pushSpeed);
        Utilitys.SetIfNegative(ref _backSpeed, data.backSpeed);
        Utilitys.SetIfNegative(ref _moveDistance, data.moveDistance);

        //위치 초기화
        _startPos = transform.position;
        _targetPos = transform.position + _direction.normalized * _moveDistance;

        //정기적인지 여부
        if (_isReglar)
        {
            Punch();
        }
    }

    private void OnCollisionEnter(Collision collision)
    {
        //플레이어와 충돌 중이고 실행일때
        if (collision.collider.CompareTag("Player") && _isPunching)
        {
            //미는 메서드 실행
            Push(collision.gameObject);
        }
    }

    //미는 메서드
    private void Push(GameObject go)
    {
        Rigidbody rb = go.GetComponent<Rigidbody>();
        if (rb != null)
        {
            //물리 처리
            rb.AddForce(_direction.normalized * _pushPower, ForceMode.Impulse);
        }

        Player player = go.GetComponent<Player>();
        if (player != null)
        {
            //움직임 제한
            ObstacleManager.Instance.StartLockMovement(player);
        }
    }

    //움직이는 메서드
    public void Punch()
    {
        //실행되는 코루틴이 없으면 코루틴 실행
        if (_punchCoroutine == null)
        {
            _punchCoroutine = StartCoroutine(PunchMove());
        }
    }

    private IEnumerator PunchMove()
    {
        do
        {
            //플래그
            _isPunching = true;

            //목표 위치로 이동
            while (Vector3.Distance(transform.position, _targetPos) > 0.01f)
            {
                transform.position = Vector3.MoveTowards(transform.position, _targetPos, _pushSpeed * Time.deltaTime);
                yield return null;
            }

            //플래그
            _isPunching = false;

            //원래 위치로 이동
            while (Vector3.Distance(transform.position, _startPos) > 0.01f)
            {
                transform.position = Vector3.MoveTowards(transform.position, _startPos, _backSpeed * Time.deltaTime);
                yield return null;
            }

            //실행 빈도 만큼 기다림
            yield return new WaitForSeconds(_regularTime);
        }
        //일시적으로 실행될때만 while문 탈출
        while (_isReglar);

        _punchCoroutine = null;
        yield return null;
    }

    private void OnDrawGizmos()
    {
        Gizmos.color = Color.yellow;

        //방향으로 선 드로우
        Gizmos.DrawLine(transform.position, transform.position + _direction * 2f);
    }
}
